name: Develop Sync Check

on:
  pull_request:
    types: [opened, synchronize, reopened]
    branches:
      - main

jobs:
  check-sync-needed:
    name: Check if develop sync is needed
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Check if PR is from develop
        id: check_source
        run: |
          SOURCE_BRANCH="${{ github.head_ref }}"
          echo "source_branch=$SOURCE_BRANCH" >> $GITHUB_OUTPUT
          
          if [[ "$SOURCE_BRANCH" == "develop" ]]; then
            echo "is_from_develop=true" >> $GITHUB_OUTPUT
            echo "ğŸ” æ£€æµ‹åˆ°æ¥è‡ª develop åˆ†æ”¯çš„ PR"
          else
            echo "is_from_develop=false" >> $GITHUB_OUTPUT
            echo "ğŸ” PR æ¥è‡ªåˆ†æ”¯: $SOURCE_BRANCH"
          fi
      
      - name: Add no-sync label for develop PRs
        if: steps.check_source.outputs.is_from_develop == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              labels: ['ğŸš« no-sync']
            });
            
            // æ·»åŠ è¯„è®ºè¯´æ˜
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: 'ğŸ¤– **è‡ªåŠ¨æ£€æµ‹**: æ­¤ PR æ¥è‡ª `develop` åˆ†æ”¯ï¼Œåˆå¹¶åå°†è·³è¿‡è‡ªåŠ¨åŒæ­¥ä»¥é˜²æ­¢å¾ªç¯ã€‚\n\nğŸ“‹ **æ ‡ç­¾è¯´æ˜**: å·²è‡ªåŠ¨æ·»åŠ  `ğŸš« no-sync` æ ‡ç­¾ã€‚'
            });
      
      - name: Check develop sync status
        if: steps.check_source.outputs.is_from_develop == 'false'
        id: check_develop
        run: |
          # æ£€æŸ¥ develop åˆ†æ”¯æ˜¯å¦è½åäº main
          git fetch origin main develop

          MAIN_COMMIT=$(git rev-parse origin/main)
          DEVELOP_COMMIT=$(git rev-parse origin/develop)

          # æ£€æŸ¥ develop æ˜¯å¦åŒ…å« main çš„æ‰€æœ‰æäº¤
          if git merge-base --is-ancestor origin/main origin/develop; then
            echo "âœ… develop åˆ†æ”¯åŒ…å« main çš„æ‰€æœ‰æäº¤"
            echo "sync_needed=false" >> $GITHUB_OUTPUT
          else
            echo "âš ï¸  develop åˆ†æ”¯è½åäº main"
            echo "sync_needed=true" >> $GITHUB_OUTPUT

            # è®¡ç®—è½åçš„æäº¤æ•°
            BEHIND_COUNT=$(git rev-list --count origin/develop..origin/main)
            echo "behind_count=$BEHIND_COUNT" >> $GITHUB_OUTPUT
          fi
      
      - name: Comment sync status
        if: steps.check_source.outputs.is_from_develop == 'false'
        uses: actions/github-script@v7
        with:
          script: |
            const syncNeeded = '${{ steps.check_develop.outputs.sync_needed }}' === 'true';
            const behindCount = '${{ steps.check_develop.outputs.behind_count }}';
            
            let message;
            if (syncNeeded) {
              message = `ğŸ“Š **åˆ†æ”¯åŒæ­¥çŠ¶æ€**\n\nâš ï¸  \`develop\` åˆ†æ”¯è½åäº \`main\` åˆ†æ”¯ ${behindCount} ä¸ªæäº¤ã€‚\n\nğŸ”„ **å»ºè®®**: æ­¤ PR åˆå¹¶åï¼Œ\`develop\` åˆ†æ”¯å°†è‡ªåŠ¨åŒæ­¥æœ€æ–°çš„ \`main\` åˆ†æ”¯ä»£ç ã€‚\n\nğŸ“‹ å¦‚éœ€è·³è¿‡è‡ªåŠ¨åŒæ­¥ï¼Œè¯·æ·»åŠ  \`ğŸš« no-sync\` æ ‡ç­¾ã€‚`;
            } else {
              message = `ğŸ“Š **åˆ†æ”¯åŒæ­¥çŠ¶æ€**\n\nâœ… \`develop\` åˆ†æ”¯å·²åŒ…å« \`main\` åˆ†æ”¯çš„æ‰€æœ‰æäº¤ï¼Œæ— éœ€åŒæ­¥ã€‚`;
            }
            
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: message
            });
