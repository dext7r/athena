name: Sync Main to Develop

on:
  push:
    branches:
      - main
  workflow_dispatch: # å…è®¸æ‰‹åŠ¨è§¦å‘

jobs:
  sync:
    name: Sync main branch to develop
    runs-on: ubuntu-latest
    
    # è·³è¿‡æ¥è‡ª develop åˆ†æ”¯çš„ PR åˆå¹¶ï¼Œé˜²æ­¢æ— é™å¾ªçŽ¯
    if: |
      github.event_name == 'workflow_dispatch' || (
        !contains(github.event.head_commit.message, 'Merge pull request') ||
        !contains(github.event.head_commit.message, 'develop')
      )
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Configure Git
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

      - name: Check if sync should be skipped
        id: check_skip
        uses: actions/github-script@v7
        with:
          script: |
            // æ£€æŸ¥æœ€è¿‘çš„ PR æ˜¯å¦æœ‰ no-sync æ ‡ç­¾
            const commitMessage = '${{ github.event.head_commit.message }}';

            // å¦‚æžœæ˜¯ PR åˆå¹¶æäº¤ï¼Œæå– PR å·ç 
            const prMatch = commitMessage.match(/Merge pull request #(\d+)/);

            if (prMatch) {
              const prNumber = parseInt(prMatch[1]);
              console.log(`æ£€æµ‹åˆ° PR åˆå¹¶: #${prNumber}`);

              try {
                const pr = await github.rest.pulls.get({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  pull_number: prNumber
                });

                const hasNoSyncLabel = pr.data.labels.some(label =>
                  label.name.includes('no-sync') || label.name.includes('ðŸš«')
                );

                const isFromDevelop = pr.data.head.ref === 'develop' ||
                                    pr.data.head.ref.includes('develop');

                if (hasNoSyncLabel || isFromDevelop) {
                  console.log('è·³è¿‡åŒæ­¥: PR åŒ…å« no-sync æ ‡ç­¾æˆ–æ¥è‡ª develop åˆ†æ”¯');
                  core.setOutput('skip', 'true');
                  return;
                }
              } catch (error) {
                console.log('æ— æ³•èŽ·å– PR ä¿¡æ¯ï¼Œç»§ç»­æ‰§è¡ŒåŒæ­¥');
              }
            }

            core.setOutput('skip', 'false');
      
      - name: Skip sync notification
        if: steps.check_skip.outputs.skip == 'true'
        run: |
          echo "â­ï¸  è·³è¿‡åŒæ­¥: æ£€æµ‹åˆ° no-sync æ ‡ç­¾æˆ–æ¥è‡ª develop åˆ†æ”¯çš„ PR"
          echo "## â­ï¸ åŒæ­¥å·²è·³è¿‡" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸš« æ£€æµ‹åˆ°ä»¥ä¸‹æ¡ä»¶ä¹‹ä¸€ï¼Œå·²è·³è¿‡è‡ªåŠ¨åŒæ­¥:" >> $GITHUB_STEP_SUMMARY
          echo "- PR åŒ…å« \\\`no-sync\\\` æ ‡ç­¾" >> $GITHUB_STEP_SUMMARY
          echo "- PR æ¥è‡ª \\\`develop\\\` åˆ†æ”¯" >> $GITHUB_STEP_SUMMARY

      - name: Check if develop branch exists
        if: steps.check_skip.outputs.skip == 'false'
        id: check_develop
        run: |
          if git show-ref --verify --quiet refs/remotes/origin/develop; then
            echo "exists=true" >> $GITHUB_OUTPUT
          else
            echo "exists=false" >> $GITHUB_OUTPUT
          fi
      
      - name: Create develop branch if not exists
        if: steps.check_skip.outputs.skip == 'false' && steps.check_develop.outputs.exists == 'false'
        run: |
          git checkout -b develop
          git push origin develop
          echo "âœ… Created develop branch from main"
      
      - name: Sync main to develop
        if: steps.check_skip.outputs.skip == 'false' && steps.check_develop.outputs.exists == 'true'
        run: |
          # åˆ‡æ¢åˆ° develop åˆ†æ”¯
          git checkout develop
          git pull origin develop
          
          # èŽ·å–å½“å‰ commit ä¿¡æ¯
          MAIN_COMMIT=$(git rev-parse origin/main)
          DEVELOP_COMMIT=$(git rev-parse HEAD)
          
          # æ£€æŸ¥æ˜¯å¦å·²ç»æ˜¯æœ€æ–°çš„
          if [ "$MAIN_COMMIT" = "$DEVELOP_COMMIT" ]; then
            echo "âœ… develop åˆ†æ”¯å·²ç»æ˜¯æœ€æ–°çš„ï¼Œæ— éœ€åŒæ­¥"
            exit 0
          fi
          
          # å°è¯•åˆå¹¶ main åˆ†æ”¯
          echo "ðŸ”„ å¼€å§‹åŒæ­¥ main åˆ†æ”¯åˆ° develop..."
          
          if git merge origin/main --no-edit; then
            # åˆå¹¶æˆåŠŸ
            git push origin develop
            echo "âœ… æˆåŠŸåŒæ­¥ main åˆ†æ”¯åˆ° develop"
            
            # è¾“å‡ºåŒæ­¥ä¿¡æ¯
            echo "ðŸ“Š åŒæ­¥è¯¦æƒ…:"
            echo "- Main commit: $MAIN_COMMIT"
            echo "- Previous develop commit: $DEVELOP_COMMIT"
            echo "- New develop commit: $(git rev-parse HEAD)"
          else
            # åˆå¹¶å†²çª
            echo "âŒ åˆå¹¶æ—¶å‘ç”Ÿå†²çªï¼Œéœ€è¦æ‰‹åŠ¨è§£å†³"
            echo "å†²çªæ–‡ä»¶:"
            git status --porcelain | grep "^UU" || true
            
            # ä¸­æ­¢åˆå¹¶
            git merge --abort
            
            # åˆ›å»º Issue é€šçŸ¥å†²çª
            echo "ðŸ”” å°†åˆ›å»º Issue é€šçŸ¥åˆå¹¶å†²çª"
            exit 1
          fi
      
      - name: Create conflict issue
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            const title = `ðŸš¨ Main to Develop åŒæ­¥å†²çª - ${new Date().toISOString().split('T')[0]}`;
            const body = `## åŒæ­¥å†²çªé€šçŸ¥\n\nåœ¨å°è¯•å°† \`main\` åˆ†æ”¯åŒæ­¥åˆ° \`develop\` åˆ†æ”¯æ—¶å‘ç”Ÿäº†åˆå¹¶å†²çªã€‚\n\n### è¯¦ç»†ä¿¡æ¯\n- **è§¦å‘æäº¤**: ${{ github.sha }}\n- **æäº¤ä¿¡æ¯**: ${{ github.event.head_commit.message }}\n- **æäº¤ä½œè€…**: ${{ github.event.head_commit.author.name }}\n- **æ—¶é—´**: ${new Date().toISOString()}\n\n### éœ€è¦æ‰‹åŠ¨æ“ä½œ\nè¯·æŒ‰ç…§ä»¥ä¸‹æ­¥éª¤æ‰‹åŠ¨è§£å†³å†²çªï¼š\n\n1. æœ¬åœ°åˆ‡æ¢åˆ° develop åˆ†æ”¯ï¼š\n   \`\`\`bash\n   git checkout develop\n   git pull origin develop\n   \`\`\`\n\n2. åˆå¹¶ main åˆ†æ”¯ï¼š\n   \`\`\`bash\n   git merge origin/main\n   \`\`\`\n\n3. è§£å†³å†²çªåŽæäº¤ï¼š\n   \`\`\`bash\n   git add .\n   git commit -m "resolve: è§£å†³ main åˆ° develop çš„åˆå¹¶å†²çª"\n   git push origin develop\n   \`\`\`\n\n### ç›¸å…³é“¾æŽ¥\n- [è§¦å‘çš„å·¥ä½œæµè¿è¡Œ](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})\n- [å†²çªçš„æäº¤](${{ github.server_url }}/${{ github.repository }}/commit/${{ github.sha }})\n\n---\n*æ­¤ Issue ç”± GitHub Actions è‡ªåŠ¨åˆ›å»º*`;
            
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: title,
              body: body,
              labels: ['ðŸš¨ conflict', 'ðŸ”„ sync', 'âš¡ urgent']
            });
      
      - name: Summary
        if: success() && steps.check_skip.outputs.skip == 'false'
        run: |
          echo "## ðŸŽ‰ åŒæ­¥å®Œæˆ" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… æˆåŠŸå°† \\\`main\\\` åˆ†æ”¯åŒæ­¥åˆ° \\\`develop\\\` åˆ†æ”¯" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### è¯¦ç»†ä¿¡æ¯" >> $GITHUB_STEP_SUMMARY
          echo "- **è§¦å‘æäº¤**: \\\`${{ github.sha }}\\\`" >> $GITHUB_STEP_SUMMARY
          echo "- **æäº¤ä¿¡æ¯**: ${{ github.event.head_commit.message }}" >> $GITHUB_STEP_SUMMARY
          echo "- **æäº¤ä½œè€…**: ${{ github.event.head_commit.author.name }}" >> $GITHUB_STEP_SUMMARY
          echo "- **åŒæ­¥æ—¶é—´**: $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
